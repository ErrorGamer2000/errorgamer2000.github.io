const n=e=>typeof e==="boolean"?e:typeof e==="string"?e.toLowerCase()==="true"?true:e.toLowerCase()==="false"?false:Boolean(e):typeof e==="object"?Array.isArray(e)?e.length>0:Object.keys(e).length>0:Boolean(e);let d;let t=0;let u=document.querySelector("canvas");let o=u.getContext("2d");let a=0;let l=false;let r=[];let c;const i=document.querySelector("audio");let f;w(u,o,2);o.fillStyle="#ff9800";document.querySelector("#uploadbtn").onclick=()=>document.querySelector('input[type="file"]').click();window.addEventListener("dragenter",e=>{e.preventDefault();document.querySelector("#upload").classList.add("dropHover");t++});document.addEventListener("dragover",e=>{e.preventDefault()});document.querySelector("#upload").addEventListener("drop",e,true);window.addEventListener("dragleave",e=>{if(--t===0){e.preventDefault();document.querySelector("#upload").classList.remove("dropHover")}});function e(e){e.preventDefault();document.querySelector("#upload").classList.remove("dropHover");if(e.dataTransfer.items){p({data:e.dataTransfer.items[0].getAsFile()})}else{p({data:e.dataTransfer.files[0]})}}const s=document.querySelector("input");s.addEventListener("change",p);async function p({data:e}){if(e){d=[e]}else{if(!n(this.files)){if(d)this.files=d;return}d=this.files}i.pause();document.querySelector("#overlay").dataset.hidden="false";(document.body||document.documentElement).classList.add("overlayed");i.dataset.hidden="true";i.src=URL.createObjectURL(d[0]);i.load();const t=await d[0].arrayBuffer();c=new Analyzer(AudioContext,t);await c.init();c.t();f=new Download(d[0].name.replace(/(.*)\..*/g,"$1[Scratch Audio Analyzer].txt"),c.o);document.querySelector("#overlay").dataset.hidden="true";(document.body||document.documentElement).classList.remove("overlayed");i.dataset.hidden="false";let o=document.createElement("a");o.href="#step2";(document.body||document.documentElement).append(o);o.click();(document.body||document.documentElement).removeChild(o);await i.play();r=[];for(let e=0;e<m.f(u.clientWidth/35)+1;e++){r.push([35*e+2.5,15])}l=true;y()&&y();document.querySelector("#downloadbtn").onclick=()=>f.init();i.addEventListener("ended",()=>{a=0;let e=document.createElement("a");e.href="#step3";(document.body||document.documentElement).append(e);e.click();(document.body||document.documentElement).removeChild(e)})}function w(e,t,o){if(!(e instanceof Element))return false;let{width:n,height:d}=e.getBoundingClientRect();e.style.height=`${d}px`;e.style.width=`${n}px`;e.height=d*o;e.width=n*o;t=e.getContext("2d");t.scale(o,o)}function y(){if(l){l=false;a=0;return true}requestAnimationFrame(y);if(i.paused)return;a+=.5;let e=m.f(a);let t=m.f(i.currentTime/i.duration*c.u.length);if(e!==a)return;o.clearRect(0,0,u.clientWidth,u.clientHeight);r.forEach(e=>{e[1]+=(u.clientHeight*.5*(c.u[t]||0)+v(50,100+50*c.u[t])-e[1])/6;o.fillRect(e[0],0,30,e[1])})}function v(e,t,o=0){let n=1;for(let e=0;e<o;e++){n*=10}return m.l(n*(m.r()*(t-e)+e))/n}
